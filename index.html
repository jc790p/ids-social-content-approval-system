<!doctype html>
<html>

<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;

            --bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(226, 232, 240, 0.8);
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --glass-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --glass-blur: blur(8px);

            --table-header-bg: #f1f5f9;
            --table-row-hover: #f8fafc;
            --tab-active-bg: var(--primary);
            --tab-active-text: #ffffff;
            --tab-inactive-bg: #ffffff;
            --tab-inactive-text: #64748b;
        }

        [data-theme='dark'] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --success: #10b981;
            --success-hover: #34d399;
            --warning: #f59e0b;
            --warning-hover: #fbbf24;
            --danger: #ef4444;
            --danger-hover: #f87171;

            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(51, 65, 85, 0.8);
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --glass-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);

            --table-header-bg: #1e293b;
            --table-row-hover: #1e293b;
            --tab-active-bg: var(--primary);
            --tab-inactive-bg: #1e293b;
            --tab-inactive-text: #94a3b8;
        }

        * {
            box-sizing: border-box;
            transition: background-color 0.2s, border-color 0.2s, color 0.1s, box-shadow 0.2s;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 24px;
            line-height: 1.5;
            transition: background-color 0.3s, color 0.3s;
        }

        h2,
        h3 {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            color: var(--text);
            margin-top: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            transition: max-width 0.3s ease;
        }

        .container.full-width {
            max-width: 98%;
        }

        /* Fixed Header Styles */
        .top-header {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: 60px;
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 24px;
            gap: 16px;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        body {
            padding-top: 84px;
            /* Account for fixed header */
        }

        .required-star {
            color: var(--danger);
            margin-left: 2px;
        }

        .optional-label {
            color: var(--text-muted);
            font-size: 12px;
            font-weight: normal;
            margin-left: 4px;
        }

        .header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--glass-shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        input,
        select,
        textarea {
            padding: 10px 14px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--tab-inactive-bg);
            color: var(--text);
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
            outline: none;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 16px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        th,
        td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: var(--table-row-hover);
        }

        .tabs {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: var(--table-header-bg);
            border-radius: 12px;
            margin-bottom: 24px;
            width: fit-content;
        }

        .tabs button {
            border: none;
            background: transparent;
            color: var(--tab-inactive-text);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            margin: 0;
        }

        .tabs button:hover {
            color: var(--text);
            background: var(--card-bg);
        }

        .tabs button.active {
            background: var(--primary) !important;
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        button:not(.tabs button) {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            border: 1px solid var(--border);
            background: var(--tab-inactive-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:not(.tabs button):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: var(--table-header-bg);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            padding: 8px !important;
            border-radius: 8px !important;
            min-width: 40px;
        }

        .btn-outline {
            background: transparent !important;
            border: 1px solid var(--border) !important;
            color: var(--text) !important;
        }

        .btn-primary {
            background: var(--primary) !important;
            color: white !important;
            border: none !important;
        }

        .btn-primary:hover {
            background: var(--primary-hover) !important;
        }

        .btn-success,
        .btn-approve {
            background: var(--success) !important;
            color: white !important;
            border: none !important;
        }

        .btn-success:hover,
        .btn-approve:hover {
            background: var(--success-hover) !important;
        }

        .btn-warning,
        .btn-edit {
            background: var(--warning) !important;
            color: white !important;
            border: none !important;
        }

        .btn-warning:hover,
        .btn-edit:hover {
            background: var(--warning-hover) !important;
        }

        .btn-danger,
        .btn-reject,
        .btn-discard {
            background: var(--danger) !important;
            color: white !important;
            border: none !important;
        }

        .btn-danger:hover,
        .btn-reject:hover,
        .btn-discard:hover {
            background: var(--danger-hover) !important;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 600;
            background: var(--table-header-bg);
            color: var(--text-muted);
        }

        .pill.ok {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .pill.warn {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .pill.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .action-link {
            color: var(--primary);
            font-weight: 500;
            text-decoration: none;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .action-link:hover {
            text-decoration: underline;
            color: var(--primary-hover);
        }

        .hidden {
            display: none !important;
        }

        .mono {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 12px;
            background: var(--table-header-bg);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        /* Dark mode toggle */
        .theme-toggle {
            cursor: pointer;
            background: var(--card-bg) !important;
            border: 1px solid var(--card-border) !important;
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }

        /* Loading */
        #sa_msg,
        #submitTopicMsg,
        #authStatus {
            font-size: 13px;
            font-weight: 500;
            color: var(--primary);
            margin-left: 10px;
        }

        /* History */
        #amHistoryArea {
            margin-top: 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .history-actor {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            display: block;
        }

        /* Modal Backdrop */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: start;
            padding-top: 50px;
            overflow-y: auto;
        }
    </style>
</head>

<div class="top-header">
    <div id="userInfoHeader" class="header-item hidden">
        <span id="headerEmail" style="font-weight:600;"></span>
        <button onclick="logout()" class="btn-outline" style="padding:4px 8px; font-size:11px;">Logout</button>
    </div>
    <div class="header-item">
        <button id="widthToggle" class="btn-outline"
            style="padding:4px 12px; font-size:12px; display:flex; align-items:center; gap:6px;" title="Toggle Width">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
                <line x1="15" y1="3" x2="15" y2="21"></line>
            </svg>
            <span id="widthText">Standard Width</span>
        </button>
    </div>
    <div class="header-item">
        <button id="themeToggle" class="btn-icon" title="Toggle Theme"></button>
    </div>
</div>

<div id="mainContainer" class="container">
    <header>
        <h1>Social Approval Portal</h1>
    </header>

    <div id="authCard" class="card">
        <p id="authStatus"
            style="font-weight:600; font-size:14px; color:var(--text-muted); display:flex; align-items:center; gap:8px;">
            <span id="statusText">Checking access...</span>
        </p>
        <div id="emailPrompt" class="hidden" style="margin-top:16px;">
            <p style="font-size:14px; margin-bottom:12px;">Please sign in with your allowlisted email:</p>
            <div class="row">
                <input type="email" id="emailInput" placeholder="your.name@example.com" style="flex:1;" />
                <button class="btn-primary" onclick="setEmail()">Sign In</button>
            </div>
        </div>
    </div>

    <!-- Diagnostic Panel -->
    <div id="diagnosticPanel" class="card"
        style="margin-top:16px; background:var(--card-bg); border:1px solid var(--card-border);">
        <details open>
            <summary style="cursor:pointer; font-weight:600; font-size:14px; margin-bottom:8px;">üîç Bootstrap
                Diagnostics</summary>
            <div id="diagnosticLog"
                style="font-family:monospace; font-size:11px; max-height:300px; overflow-y:auto; background:rgba(0,0,0,0.05); padding:8px; border-radius:4px; white-space:pre-wrap;">
                Waiting for bootstrap...</div>
            <button onclick="clearDiagnostics()" style="margin-top:8px; padding:4px 8px; font-size:11px;">Clear
                Log</button>
        </details>
    </div>

    <div id="tabs" class="tabs hidden">
        <button onclick="showTab('submitTopic')" class="active">Submit Topic</button>
        <button onclick="showTab('myTopics')">My Content</button>
        <button id="tabReviewQueue" onclick="showTab('reviewQueue')" class="hidden">Review Queue</button>
        <button id="tabPublisherQueue" onclick="showTab('publisherQueue')" class="hidden">Publisher Queue</button>
        <button id="tabAdmin" onclick="showTab('adminPanel')" class="hidden">Admin</button>
    </div>

    <!-- TAB: SUBMIT TOPIC -->
    <div id="submitTopic" class="tab-content">
        <div class="card" style="border-top: 4px solid var(--primary);">
            <h3 style="margin-bottom:20px;">Submit New Topic</h3>

            <div class="row" style="gap:20px; align-items:flex-start;">
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Page / Account<span
                            class="required-star">*</span></div>
                    <select id="pageSelect"></select>
                </div>
                <div style="flex:2;">
                    <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Topic Title<span
                            class="required-star">*</span></div>
                    <input id="topicTitle" placeholder="e.g. 5 Tips for Better Engagement" />
                </div>
            </div>

            <div style="margin-top:20px;">
                <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Google Doc URL (Outline)<span
                        class="optional-label">(optional)</span></div>
                <input id="topicDocUrl" placeholder="https://docs.google.com/..." />
            </div>

            <div style="margin-top:20px;">
                <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Notes / Instructions<span
                        class="optional-label">(optional)</span></div>
                <textarea id="topicNotes"
                    placeholder="Any specific requirements or context for the writer..."></textarea>
            </div>

            <div class="row" style="margin-top:24px; justify-content:space-between;">
                <button class="btn-primary" onclick="submitTopic(this)" id="btnSubmitTopic">Submit Topic</button>
                <span id="submitTopicMsg"></span>
            </div>
        </div>
    </div>

    <!-- TAB: MY TOPICS -->
    <div id="myTopics" class="tab-content hidden">
        <div class="card" style="border-left: 4px solid var(--primary);">
            <h3>My Topics & Articles</h3>
            <div id="myTopicsTable"></div>
        </div>
    </div>

    <!-- TAB: REVIEW QUEUE -->
    <div id="reviewQueue" class="tab-content hidden">
        <div class="card" style="border-left: 4px solid var(--warning);">
            <h3>Review Queues</h3>

            <div id="topicQueueSection">
                <h4 style="font-family:'Outfit'; margin-bottom:12px;">Topics Waiting approval</h4>
                <div id="topicQueueTable"></div>
            </div>

            <div id="articleQueueSection"
                style="margin-top:32px; border-top:1px solid var(--border); padding-top:24px;">
                <h4 style="font-family:'Outfit'; margin-bottom:12px;">Articles Waiting review</h4>
                <div id="articleQueueTable"></div>
            </div>
        </div>
    </div>

    <!-- TAB: PUBLISHER QUEUE -->
    <div id="publisherQueue" class="tab-content hidden">
        <div class="card" style="border-left: 4px solid var(--success);">
            <h3>Publisher Queue</h3>
            <div id="publisherQueueTable"></div>
        </div>
    </div>

    <!-- TAB: ADMIN PANEL -->
    <div id="adminPanel" class="tab-content hidden">
        <div class="card" style="border-left: 4px solid var(--danger);">
            <h3>Admin Control Panel</h3>
            <div id="adminTable"></div>
            <hr style="margin:24px 0; border:0; border-top:1px solid var(--border);" />

            <h4 style="font-family:'Outfit';">Slack Integration Debug</h4>
            <div class="row" style="gap:16px; margin-top:12px;">
                <input id="testSlackPage" placeholder="Page ID (e.g. pg01)" style="flex:1;" />
                <select id="testSlackType" style="flex:1;">
                    <option value="TOPIC_READY">Topic Ready</option>
                    <option value="ARTICLE_SUBMITTED">Article Submitted</option>
                </select>
                <button class="btn-primary" onclick="testSlack()">Send Test</button>
            </div>
            <div id="testSlackMsg" style="margin-top:8px; font-size:12px;"></div>

            <div style="margin-top:32px;">
                <h4 style="font-family:'Outfit';">System Diagnostics</h4>
                <button onclick="runDebug()" style="margin-top:8px;">Run Full Health Check</button>
                <pre id="debugOut" class="mono" style="margin-top:12px; max-height:300px; overflow:auto;"></pre>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: ACTION -->
<div id="actionModal" class="modal-overlay hidden">
    <div class="card" style="max-width: 500px; width: 95%; margin-top: 60px; border-top: 6px solid var(--primary);">
        <h3 id="amTitle">Action</h3>
        <div id="amLabel" style="font-size:14px; font-weight:600; margin-bottom:8px;"></div>
        <input id="amInput" style="margin-bottom:16px;" />
        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Comments / Feedback <span id="amRequired"
                style="color:var(--danger); display:none;">*</span></div>
        <textarea id="amComments" placeholder="Enter details here..."></textarea>

        <div id="amHistoryTitle" style="margin-top:20px; font-weight:700; font-size:14px; display:none;">Recent
            History</div>
        <div id="amHistoryArea" style="display:none;"></div>

        <div class="row" style="justify-content: flex-end; gap:12px; margin-top:24px;">
            <button onclick="closeActionModal()">Cancel</button>
            <button id="amBtnConfirm" class="btn-primary">Confirm</button>
        </div>
    </div>
</div>

<!-- MODAL: SUBMIT ARTICLE -->
<div id="submitArticleModal" class="modal-overlay hidden">
    <div class="card" style="max-width: 650px; width: 95%; margin-top: 40px; border-top: 6px solid var(--success);">
        <h3>Submit Article</h3>
        <div
            style="background:var(--table-header-bg); padding:12px; border-radius:8px; margin-bottom:20px; font-size:13px;">
            <div style="font-weight:700; font-size:15px; font-family:'Outfit';">Submit Article Content</div>
            <div style="font-weight:600; color:var(--text-muted); margin-bottom:4px; margin-top:8px;">Draft Content for:
            </div>
            <div id="sa_topicTitle" style="font-weight:700; font-size:15px; font-family:'Outfit';"></div>
            <div style="font-size:11px; margin-top:4px; opacity:0.8;">Topic ID: <span id="sa_topicId"
                    class="pill"></span></div>
        </div>

        <div style="margin-bottom:16px;">
            <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Final Content URL (Google Doc)<span
                    class="required-star">*</span></div>
            <input id="sa_contentUrl" placeholder="https://docs.google.com/..." />
        </div>

        <div class="row" style="gap:20px; margin-bottom:16px;">
            <div style="flex:1;">
                <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Language<span
                        class="required-star">*</span></div>
                <select id="sa_language">
                    <option value="Thai">Thai</option>
                    <option value="English">English</option>
                </select>
            </div>
            <div style="flex:1;">
                <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Image Assets URL<span
                        class="optional-label">(optional)</span></div>
                <input id="sa_imageUrls" placeholder="Google Drive / Dropbox link..." />
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Notes to Reviewer<span
                    class="optional-label">(optional)</span></div>
            <textarea id="sa_notes" placeholder="Explain any specifics or things to check..."></textarea>
        </div>

        <div
            style="background:var(--card-bg); border:1px solid var(--card-border); padding:12px; border-radius:8px; display:flex; align-items:center; gap:12px;">
            <input type="checkbox" id="sa_readyCheck" style="width:20px; height:20px; margin:0;" />
            <label for="sa_readyCheck" style="font-size:13px; font-weight:500; cursor:pointer;">I confirm this
                article is complete and ready for review.</label>
        </div>

        <div class="row" style="justify-content: flex-end; gap:12px; margin-top:24px;">
            <span id="sa_msg"></span>
            <button onclick="closeSubmitArticle()">Cancel</button>
            <button id="btnSubmitArt" class="btn-primary" onclick="doSubmitArticle()">Submit Article</button>
        </div>
    </div>
</div>

<script>
    // If any JS error happens, show it in Diagnostics output.
    window.addEventListener('error', (e) => {
        const el = document.getElementById('debugOut');
        if (el) el.innerText = 'JS Error: ' + (e.message || e.type || 'unknown') + (e.filename ? ('\n' + e.filename + ':' + e.lineno + ':' + e.colno) : '');
    });

    let ctx = null;
    let clientEmail = localStorage.getItem("portal_email") || "";

    // Diagnostic Logging
    function logDiagnostic(message, type = 'info') {
        const log = document.getElementById('diagnosticLog');
        if (!log) return;
        const timestamp = new Date().toLocaleTimeString();
        const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        log.textContent += `\n[${timestamp}] ${prefix} ${message}`;
        log.scrollTop = log.scrollHeight;
        console.log(`[DIAGNOSTIC] ${message}`);
    }

    function clearDiagnostics() {
        const log = document.getElementById('diagnosticLog');
        if (log) log.textContent = 'Log cleared.\n';
    }

    const CFG = {
        TOPIC_STATUSES: {
            UNDER_REVIEW: "Under Review",
            CHANGES: "Changes Requested",
            APPROVED: "Approved",
            DISCARDED: "Discarded",
            REJECTED: "Rejected",
            DRAFT: "Draft"
        },
        ARTICLE_STATUSES: {
            UNDER_REVIEW: "Under Review",
            CHANGES: "Changes Requested",
            READY: "Ready to Post",
            POSTED: "Posted",
            REJECTED: "Rejected"
        }
    };

    function setEmail() {
        const e = document.getElementById("emailInput").value.trim().toLowerCase();
        if (!e) return;
        localStorage.setItem("portal_email", e);
        clientEmail = e;
        bootstrap();
    }

    // Initialize Theme
    (function () {
        const savedTheme = localStorage.getItem('portal_theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = savedTheme || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        updateThemeIcon(theme);
    })();

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('portal_theme', target);
        updateThemeIcon(target);
    }

    function updateThemeIcon(theme) {
        const btn = document.getElementById('themeToggle');
        if (!btn) return;
        btn.innerHTML = theme === 'dark'
            ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="4.22" x2="19.78" y2="5.64"></line></svg>'
            : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
    }

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // Adjustable Width Logic
    function toggleWidth() {
        const container = document.getElementById('mainContainer');
        const btnText = document.getElementById('widthText');
        const isFull = container.classList.toggle('full-width');
        const mode = isFull ? 'wide' : 'standard';
        // Show what clicking will do NEXT (opposite of current state)
        btnText.innerText = isFull ? 'Standard Width' : 'Wide Width';
        localStorage.setItem('portal_width', mode);
    }

    (function () {
        const savedWidth = localStorage.getItem('portal_width');
        if (savedWidth === 'wide') {
            const container = document.getElementById('mainContainer');
            const btnText = document.getElementById('widthText');
            if (container) container.classList.add('full-width');
            // Show what clicking will do NEXT (switch to standard)
            if (btnText) btnText.innerText = 'Standard Width';
        }
    })();

    const widthToggle = document.getElementById('widthToggle');
    if (widthToggle) widthToggle.addEventListener('click', toggleWidth);

    function showTab(id) {
        closeActionModal(); // Keep existing modal closing behavior
        closeSubmitArticle(); // Keep existing modal closing behavior

        // Hide all tab-content divs
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        const target = document.getElementById(id);
        if (target) target.classList.remove('hidden');

        // Update active state on tab buttons
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        const activeBtn = document.querySelector(`.tabs button[onclick*="'${id}'"]`);
        if (activeBtn) activeBtn.classList.add('active');

        // Refresh specific data if needed
        if (id === 'myTopics') refreshMyTopics();
        if (id === 'reviewQueue') { refreshTopicQueue(); refreshArticleQueue(); }
        if (id === 'publisherQueue') refreshPublisherQueue();
        if (id === 'adminPanel') refreshAdmin();
    }

    function bootstrap() {
        logDiagnostic('Bootstrap started');
        logDiagnostic(`Client email from localStorage: "${clientEmail}"`);

        document.getElementById("statusText").innerText = "Checking access...";

        logDiagnostic('Calling api_getContext...');

        if (typeof google === "undefined" || !google.script || !google.script.run) {
            const msg = "Google Apps Script runtime not available. Please open via the published web app.";
            logDiagnostic(msg, 'error');
            document.getElementById("authStatus").innerText = msg;
            document.getElementById("statusText").innerText = msg;
            return;
        }

        const bootstrapTimeout = setTimeout(() => {
            const msg = "Still waiting for access check... please refresh or try again.";
            logDiagnostic(msg, 'warn');
            document.getElementById("authStatus").innerText = msg;
            document.getElementById("statusText").innerText = msg;
        }, 12000);

        google.script.run
            .withSuccessHandler(res => {
                clearTimeout(bootstrapTimeout);
                logDiagnostic('Success handler called', 'success');
                logDiagnostic(`Response received: ${JSON.stringify(res).substring(0, 200)}...`);

                if (!res || !res.ok) {
                    const errorMsg = (res && res.message) || "Access error";
                    logDiagnostic(`Response not OK: ${errorMsg}`, 'error');
                    document.getElementById("authStatus").innerText = errorMsg;
                    document.getElementById("statusText").innerText = errorMsg;
                    if (res && res.code === "NO_EMAIL") {
                        logDiagnostic('NO_EMAIL code detected, showing email prompt', 'warn');
                        document.getElementById("emailPrompt").classList.remove("hidden");
                    }
                    return;
                }

                logDiagnostic('Response OK, setting ctx');
                ctx = res;

                if (!ctx.roles || !ctx.pages) {
                    logDiagnostic('Incomplete server response - missing roles or pages', 'error');
                    logDiagnostic(`Has roles: ${!!ctx.roles}, Has pages: ${!!ctx.pages}`);
                    document.getElementById("authStatus").innerText = "Error: Incomplete server response.";
                    document.getElementById("statusText").innerText = "Error: Incomplete server response.";
                    return;
                }

                logDiagnostic('Updating UI elements...');
                document.getElementById("statusText").innerText = "Success";
                logDiagnostic('Status text updated');

                // Populate Header
                const headerEmail = document.getElementById("headerEmail");
                if (headerEmail) {
                    headerEmail.innerText = ctx.email;
                    logDiagnostic(`Header email set to: ${ctx.email}`);
                } else {
                    logDiagnostic('headerEmail element not found!', 'warn');
                }

                const userInfoHeader = document.getElementById("userInfoHeader");
                if (userInfoHeader) {
                    userInfoHeader.classList.remove("hidden");
                    logDiagnostic('User info header shown');
                } else {
                    logDiagnostic('userInfoHeader element not found!', 'warn');
                }

                const authCard = document.getElementById("authCard");
                if (authCard) {
                    authCard.classList.add("hidden");
                    logDiagnostic('Auth card hidden');
                } else {
                    logDiagnostic('authCard element not found!', 'warn');
                }

                const tabs = document.getElementById("tabs");
                if (tabs) {
                    tabs.classList.remove("hidden");
                    logDiagnostic('Tabs shown');
                } else {
                    logDiagnostic('tabs element not found!', 'warn');
                }

                const isSuper = ctx.roles.is_super_admin;
                const isAuthor = ctx.roles.is_author;
                const isReviewer = ctx.roles.is_article_reviewer;
                const isPublisher = ctx.roles.is_publisher;

                logDiagnostic(`User roles: super=${isSuper}, author=${isAuthor}, reviewer=${isReviewer}, publisher=${isPublisher}`);

                // Consolidated Review Queue visibility
                const canSeeReview = isAuthor || isReviewer || isSuper;
                const tabReview = document.getElementById("tabReviewQueue");
                if (tabReview) tabReview.classList.toggle("hidden", !canSeeReview);

                const sectionTopic = document.getElementById("topicQueueSection");
                if (sectionTopic) sectionTopic.classList.toggle("hidden", !canSeeReview);

                const sectionArticle = document.getElementById("articleQueueSection");
                if (sectionArticle) sectionArticle.classList.toggle("hidden", !(isReviewer || isSuper));

                const tabPub = document.getElementById("tabPublisherQueue");
                if (tabPub) tabPub.classList.toggle("hidden", !(isPublisher || isSuper));

                const tabAdmin = document.getElementById("tabAdmin");
                if (tabAdmin) tabAdmin.classList.toggle("hidden", !isSuper);

                logDiagnostic('Loading pages...');
                loadPages(ctx.pages);
                logDiagnostic('Showing submit topic tab...');
                showTab("submitTopic");
                logDiagnostic('Bootstrap completed successfully!', 'success');
            })
            .withFailureHandler(err => {
                clearTimeout(bootstrapTimeout);
                logDiagnostic(`Failure handler called: ${err.message}`, 'error');
                logDiagnostic(`Error details: ${JSON.stringify(err)}`, 'error');
                document.getElementById("authStatus").innerText = "Error: " + err.message;
                document.getElementById("statusText").innerText = "Error: " + err.message;
            })
            .api_getContext(clientEmail);

        logDiagnostic('api_getContext call initiated (async)');
    }

    function logout() {
        closeActionModal();
        closeSubmitArticle();
        localStorage.removeItem("portal_email");
        ctx = null;
        const headerEmail = document.getElementById("headerEmail");
        if (headerEmail) headerEmail.innerText = "";
        document.getElementById("userInfoHeader").classList.add("hidden");
        document.getElementById("statusText").innerText = "Logged out.";
        document.getElementById("authCard").classList.remove("hidden");
        document.getElementById("emailPrompt").classList.remove("hidden");
        document.getElementById("tabs").classList.add("hidden");
        document.getElementById("emailInput").value = "";
    }

    function runDebug() {
        const dbg = document.getElementById("debugOut");
        const email = (ctx && ctx.email) ? ctx.email : (document.getElementById("emailInput").value || "").trim().toLowerCase();

        if (!email) {
            dbg.innerText = "Enter your email first, then click Diagnostics.";
            return;
        }

        dbg.innerText = `[Local Context]\nEmail: ${email}\nRoles: ${ctx ? JSON.stringify(ctx.roles) : 'Not loaded'}\n\nRunning backend diagnostics...`;

        google.script.run
            .withSuccessHandler(res => {
                if (!res) {
                    dbg.innerText += "\n\nServer returned no response.";
                } else if (res.ok) {
                    dbg.innerText += "\n\n[Backend Success]\n" + JSON.stringify(res.details || res, null, 2);
                } else {
                    dbg.innerText += "\n\n[Backend Error]\n" + res.message;
                }
            })
            .withFailureHandler(err => {
                dbg.innerText += "\n\n[Critical Error]\n" + err.message;
            })
            .api_debug({ email });
    }

    function loadPages(pages) {
        const sel = document.getElementById("pageSelect");
        sel.innerHTML = "";
        pages.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.page_id;
            opt.textContent = `${p.page_id} ‚Äî ${p.page_name}`;
            sel.appendChild(opt);
        });
    }

    function submitTopic(btn) {
        const payload = {
            email: ctx.email,
            page_id: document.getElementById("pageSelect").value,
            topic_title: document.getElementById("topicTitle").value,
            content_doc_url: document.getElementById("topicDocUrl").value,
            notes: document.getElementById("topicNotes").value
        };
        if (!payload.topic_title) { alert("Title is required."); return; }

        btn.disabled = true;
        document.getElementById("submitTopicMsg").innerText = "Submitting‚Ä¶";
        google.script.run
            .withSuccessHandler(res => {
                btn.disabled = false;
                document.getElementById("submitTopicMsg").innerText =
                    res.ok ? ("Submitted: " + res.topic_id) : "Failed";
                document.getElementById("topicTitle").value = "";
                document.getElementById("topicDocUrl").value = "";
                document.getElementById("topicNotes").value = "";
            })
            .withFailureHandler(err => {
                btn.disabled = false;
                document.getElementById("submitTopicMsg").innerText = "Error: " + err.message;
            })
            .api_submitTopic(payload);
    }

    function fmtWait(submittedAt) {
        if (!submittedAt) return "";
        const t = new Date(submittedAt).getTime();
        if (!t) return "";
        const mins = Math.floor((Date.now() - t) / 60000);
        if (mins < 60) return mins + "m";
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return h + "h " + m + "m";
    }

    function renderLoading(id) {
        const el = document.getElementById(id);
        if (el) {
            const msgId = id + "_loadingMsg";
            if (!document.getElementById(msgId)) {
                const msg = document.createElement("div");
                msg.id = msgId;
                msg.className = "mono";
                msg.style = "position:absolute; background:var(--card-bg); backdrop-filter:blur(4px); padding:8px 16px; border-radius:8px; font-size:12px; color:var(--primary); pointer-events:none; border:1px solid var(--card-border); margin-top: -40px; z-index:10; box-shadow:var(--glass-shadow); font-weight:600;";
                msg.innerText = "Refreshing...";
                el.prepend(msg);
            }
        }
    }

    function clearLoading(id) {
        const msg = document.getElementById(id + "_loadingMsg");
        if (msg) msg.remove();
    }

    function refreshMyTopics() {
        renderLoading("myTopicsTable");
        google.script.run
            .withSuccessHandler(res => {
                clearLoading("myTopicsTable");
                const topics = res.topics || [];
                const articles = res.articles || [];
                document.getElementById("myTopicsTable").innerHTML = renderMyTopics(topics, articles);
            })
            .withFailureHandler(err => {
                clearLoading("myTopicsTable");
                document.getElementById("myTopicsTable").innerText = "Error: " + err.message;
            })
            .api_listMyTopics({ email: ctx.email });
    }

    function refreshTopicQueue() {
        renderLoading("topicQueueTable");
        google.script.run
            .withSuccessHandler(res => {
                clearLoading("topicQueueTable");
                const topics = res.topics || [];
                document.getElementById("topicQueueTable").innerHTML = renderQueue(topics);
            })
            .withFailureHandler(err => {
                clearLoading("topicQueueTable");
                document.getElementById("topicQueueTable").innerText = "Error: " + err.message;
            })
            .api_listTopicQueue({ email: ctx.email });
    }

    function refreshPublisherQueue() {
        renderLoading("publisherQueueTable");
        google.script.run
            .withSuccessHandler(res => {
                clearLoading("publisherQueueTable");
                const articles = res.publisherQueue || [];
                document.getElementById("publisherQueueTable").innerHTML = renderPublisherQueue(articles);
            })
            .withFailureHandler(err => {
                clearLoading("publisherQueueTable");
                document.getElementById("publisherQueueTable").innerText = "Error: " + err.message;
            })
            .api_listArticles({ email: ctx.email });
    }

    function refreshArticleQueue() {
        renderLoading("articleQueueTable");
        google.script.run
            .withSuccessHandler(res => {
                clearLoading("articleQueueTable");
                const articles = res.queue || [];
                document.getElementById("articleQueueTable").innerHTML = renderArticleQueue(articles);
            })
            .withFailureHandler(err => {
                clearLoading("articleQueueTable");
                document.getElementById("articleQueueTable").innerText = "Error: " + err.message;
            })
            .api_listArticles({ email: ctx.email });
    }

    function renderMyTopics(topics, articles) {
        if (!topics.length) return "<div style='padding:20px; color:var(--text-muted);'>No topics yet.</div>";
        let html = "<table><thead><tr>" +
            "<th>ID</th><th>Title</th><th>Page</th><th>Status</th><th>Submitted</th><th>Actions</th></tr></thead><tbody>";

        topics.forEach(t => {
            const associatedArticles = articles.filter(a => a.topic_id === t.topic_id);
            const latestA = associatedArticles.length > 0 ? associatedArticles[associatedArticles.length - 1] : null;

            let statusStr = "";
            let statusClass = "";

            if (latestA) {
                statusStr = latestA.status;
                if (latestA.status === CFG.ARTICLE_STATUSES.READY) statusClass = "ok";
                else if (latestA.status === CFG.ARTICLE_STATUSES.CHANGES) statusClass = "warn";
            } else {
                statusStr = t.status;
                if (t.status === CFG.TOPIC_STATUSES.APPROVED) statusClass = "ok";
                else if (t.status === CFG.TOPIC_STATUSES.CHANGES) statusClass = "warn";
                else if (t.status === "REJECTED") statusClass = "danger";
            }

            let actions = "";
            if (t.status === CFG.TOPIC_STATUSES.CHANGES) {
                actions += ` <button class=\"btn-warning\" onclick=\"resubmitTopic('${t.topic_id}', '${escapeHtml(t.topic_title || '')}')\">Resubmit Topic</button>`;
            } else if (t.status === CFG.TOPIC_STATUSES.APPROVED) {
                if (!latestA) {
                    actions += ` <button class=\"btn-success\" onclick=\"openSubmitArticle('${t.topic_id}', '${escapeHtml(t.topic_title || '')}')\">Submit Article</button>`;
                } else if (latestA.status === CFG.ARTICLE_STATUSES.CHANGES) {
                    actions += ` <button class=\"btn-warning\" onclick=\"openResubmitArticle('${latestA.article_id}', '${escapeHtml(t.topic_title || '')}', '${escapeHtml(latestA.content_doc_url || '')}', '${escapeHtml(latestA.notes_to_reviewer || '')}')\">Resubmit Article</button>`;
                }
            }

            if (t.status === CFG.TOPIC_STATUSES.UNDER_REVIEW || t.status === CFG.TOPIC_STATUSES.CHANGES) {
                actions += ` <button class=\"btn-danger\" onclick=\"discardTopic('${t.topic_id}')\">Withdraw</button>`;
            }

            html += `<tr>
                        <td><span class=\"pill\">${t.topic_id}</span></td>
                        <td style=\"font-weight:600;\">${escapeHtml(t.topic_title || '')}</td>
                        <td><span class=\"pill\">${t.page_id}</span></td>
                        <td><span class=\"pill ${statusClass}\">${statusStr}</span></td>
                        <td style=\"white-space:nowrap;\">${fmtWait(t.submitted_at)} ago</td>
                        <td>
                            ${actions}
                            <div style=\"margin-top:8px;\">
                                <a class=\"action-link\" onclick=\"showHistory('TOPIC', '${t.topic_id}')\">History</a>
                                ${t.content_doc_url ? ` | <a href=\"${t.content_doc_url}\" target=\"_blank\" class=\"action-link\">View Outline</a>` : ''}
                            </div>
                        </td>
                    </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }

    function renderQueue(topics) {
        if (!topics.length) return "<div style='padding:20px; color:var(--text-muted);'>Topic queue is clear.</div>";
        let html = "<table><thead><tr>" +
            "<th>ID</th><th>Title</th><th>Page</th><th>Author</th><th>Waiting</th><th>Actions</th></tr></thead><tbody>";
        topics.forEach(t => {
            html += `<tr>
                        <td><span class=\"pill\">${t.topic_id}</span></td>
                        <td style=\"font-weight:600;\">${escapeHtml(t.topic_title || '')}</td>
                        <td><span class=\"pill\">${t.page_id}</span></td>
                        <td>${escapeHtml(t.author_name || t.author_email || '')}</td>
                        <td>${fmtWait(t.submitted_at)}</td>
                        <td>
                            <button class=\"btn-success\" onclick=\"approveTopic('${t.topic_id}')\">Approve</button>
                            <button class=\"btn-warning\" onclick=\"requestEditTopic('${t.topic_id}')\">Request edit</button>
                            <button class=\"btn-danger\" onclick=\"rejectTopic('${t.topic_id}')\">Reject</button>
                            <div style=\"margin-top:8px;\">
                                <a class=\"action-link\" onclick=\"showHistory('TOPIC', '${t.topic_id}')\">History</a>
                                ${t.content_doc_url ? ` | <a href=\"${t.content_doc_url}\" target=\"_blank\" class=\"action-link\">View Outline</a>` : ''}
                                ${ctx.roles.is_super_admin ? ` | <a class=\"action-link\" onclick=\"adminOverrideTopic('${t.topic_id}')\">Override</a>` : ''}
                            </div>
                        </td>
                    </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }

    function renderArticleQueue(articles) {
        if (!articles.length) return "<div style='padding:20px; color:var(--text-muted);'>No articles waiting.</div>";
        let html = "<table><thead><tr>" +
            "<th>ID</th><th>Topic</th><th>Page</th><th>Author</th><th>Status</th><th>Waiting</th><th>Reviewer</th><th>Actions</th></tr></thead><tbody>";
        articles.forEach(a => {
            let actions = "";
            if (!a.assigned_reviewer_email) {
                actions = `<button class="btn-primary" onclick=\"claimArticle('${a.article_id}')\">Claim Review</button>`;
            } else if (a.assigned_reviewer_email === ctx.email) {
                actions = `<button class="btn-success" onclick=\"reviewArticle('${a.article_id}', 'APPROVE')\">Approve</button> ` +
                    `<button class="btn-warning" onclick=\"reviewArticle('${a.article_id}', 'CHANGES')\">Request edit</button> ` +
                    `<button class="btn-danger\" onclick=\"reviewArticle('${a.article_id}', 'REJECT')\">Reject</button>`;
            } else {
                actions = `<span class="mono">${escapeHtml(a.reviewer_name || a.assigned_reviewer_email)}</span>`;
            }

            html += `<tr>
                        <td><span class=\"pill\">${a.article_id}</span></td>
                        <td style=\"font-weight:600;\">${escapeHtml(a.topic_title || 'Topic ' + a.topic_id)}</td>
                        <td><span class=\"pill\">${a.page_id}</span></td>
                        <td>${escapeHtml(a.author_name || a.author_email || '')}</td>
                        <td><span class=\"pill\">${a.status}</span></td>
                        <td>${fmtWait(a.submitted_at)}</td>
                        <td>${escapeHtml(a.reviewer_name || 'Unassigned')}</td>
                        <td>
                            ${actions}
                            <div style=\"margin-top:8px;\">
                                <a href=\"${a.content_doc_url}\" target=\"_blank\" class=\"action-link\">View Doc</a> | 
                                <a class=\"action-link\" onclick=\"showHistory('ARTICLE', '${a.article_id}')\">History</a>
                                ${ctx.roles.is_super_admin ? ` | <a class=\"action-link\" onclick=\"adminOverrideArticle('${a.article_id}')\">Override</a>` : ''}
                            </div>
                        </td>
                    </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }


    function renderArticleQueue(articles) {
        if (!articles.length) return "<div style='padding:20px; color:var(--text-muted);'>No articles waiting review.</div>";
        let html = "<table><thead><tr>" +
            "<th>ID</th><th>Topic</th><th>Page</th><th>Author</th><th>Waiting</th><th>Status</th><th>Actions</th></tr></thead><tbody>";
        articles.forEach(a => {
            let actions = "";
            if (ctx.roles.is_super_admin || (ctx.roles.is_article_reviewer && a.status === CFG.ARTICLE_STATUSES.UNDER_REVIEW)) {
                actions += `<button class=\"btn-approve\" onclick=\"reviewArticle('${a.article_id}', 'READY')\">Approve</button>
                           <button class=\"btn-edit\" onclick=\"reviewArticle('${a.article_id}', 'CHANGES')\">Request Edit</button>`;
            }

            html += `<tr>
                        <td><span class=\"pill\">${a.article_id}</span></td>
                        <td style=\"font-weight:600;\">${escapeHtml(a.topic_title || 'Topic ' + a.topic_id)}</td>
                        <td><span class=\"pill\">${a.page_id}</span></td>
                        <td>${escapeHtml(a.author_name || a.author_email || '')}</td>
                        <td>${formatWaitTime(a.submitted_at)}</td>
                        <td><span class=\"pill\">${a.status}</span></td>
                        <td>
                            ${actions}
                            <div style=\"margin-top:8px;\">
                                <a href=\"${a.content_doc_url}\" target=\"_blank\" class=\"action-link\">View Doc</a> | 
                                <a class=\"action-link\" onclick=\"showHistory('ARTICLE', '${a.article_id}')\">History</a>
                                ${ctx.roles.is_super_admin ? ` | <a class=\"action-link\" onclick=\"adminOverrideArticle('${a.article_id}')\">Override</a>` : ''}
                            </div>
                        </td>
                    </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }

    function renderPublisherQueue(articles) {
        if (!articles.length) return "<div style='padding:20px; color:var(--text-muted);'>Queue is clear.</div>";
        let html = "<table><thead><tr>" +
            "<th>ID</th><th>Topic</th><th>Page</th><th>Author</th><th>Status</th><th>Actions</th></tr></thead><tbody>";
        articles.forEach(a => {
            html += `<tr>
                        <td><span class=\"pill\">${a.article_id}</span></td>
                        <td style=\"font-weight:600;\">${escapeHtml(a.topic_title || 'Topic ' + a.topic_id)}</td>
                        <td><span class=\"pill\">${a.page_id}</span></td>
                        <td>${escapeHtml(a.author_name || a.author_email || '')}</td>
                        <td><span class=\"pill ok\">${a.status}</span></td>
                        <td>
                            <button class=\"btn-success\" onclick=\"markPosted('${a.article_id}')\">Mark Posted</button>
                            <div style=\"margin-top:8px;\">
                                <a href=\"${a.content_doc_url}\" target=\"_blank\" class=\"action-link\">View Doc</a> | 
                                <a class=\"action-link\" onclick=\"showHistory('ARTICLE', '${a.article_id}')\">History</a>
                                ${ctx.roles.is_super_admin ? ` | <a class=\"action-link\" onclick=\"adminOverrideArticle('${a.article_id}')\">Override</a>` : ''}
                            </div>
                        </td>
                    </tr>`;
        });
        html += "</tbody></table>";
        return html;
    }

    function showHistory(type, id) {
        openActionModal({
            title: `History: ${type} ${id}`,
            label: "",
            showInput: false,
            requireComments: false,
            showHistory: true,
            onConfirm: () => closeActionModal()
        });
        loadHistory(type, id);
    }

    // --- GENERIC ACTION MODAL ---
    let currentActionCallback = null;
    let _modalConfirmCallback = null; // New callback for the refined modal

    function openActionModal(opts) {
        const m = document.getElementById("actionModal");
        document.getElementById("amTitle").innerText = opts.title || "Action";

        const lbl = document.getElementById("amLabel");
        lbl.innerText = opts.label || "";
        lbl.style.display = opts.label ? "block" : "none";

        const inp = document.getElementById("amInput");
        inp.value = opts.initialValue || "";
        inp.placeholder = opts.placeholder || "";
        inp.style.display = opts.showInput ? "block" : "none";

        const cmts = document.getElementById("amComments");
        cmts.value = "";
        cmts.placeholder = opts.commentPlaceholder || "Enter details here...";

        document.getElementById("amRequired").style.display = opts.requireComments ? "inline" : "none";

        const histArea = document.getElementById("amHistoryArea");
        const histTitle = document.getElementById("amHistoryTitle");
        if (opts.showHistory) {
            histTitle.style.display = "block";
            histArea.style.display = "block";
            histArea.innerHTML = "<i>Loading...</i>";
        } else {
            histTitle.style.display = "none";
            histArea.style.display = "none";
        }

        m.classList.remove("hidden");
        _modalConfirmCallback = opts.onConfirm;
    }

    function refreshAdmin() {
        document.getElementById("adminTable").innerHTML = `
                <div style="padding:20px; color:var(--text-muted);">
                    Admin features are integrated into the Topic and Article queues (Override/Unassign buttons).
                </div>
            `;
    }

    function closeActionModal() {
        document.getElementById("actionModal").classList.add("hidden");
        _modalConfirmCallback = null;
    }

    document.getElementById("amBtnConfirm").onclick = function () {
        if (_modalConfirmCallback) {
            const btn = this;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Processing...";

            _modalConfirmCallback(() => {
                btn.disabled = false;
                btn.innerText = originalText;
            });
        }
    };

    function approveTopic(topicId) {
        openActionModal({
            title: "Approve Topic",
            label: "Approve Topic: " + topicId,
            commentPlaceholder: "Optional approval note...",
            onConfirm: (done) => {
                const comment = document.getElementById("amComments").value.trim();
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshTopicQueue(); if (done) done(); })
                    .api_topicApprove({ email: ctx.email, topic_id: topicId, comment });
            }
        });
    }

    function requestEditTopic(topicId) {
        openActionModal({
            title: "Request edits for Topic " + topicId,
            label: "Please explain what needs to be changed.",
            requireComments: true,
            commentPlaceholder: "Change Request (required)",
            onConfirm: (done) => {
                const comment = document.getElementById("amComments").value.trim();
                if (!comment) {
                    alert("Comment is required.");
                    if (done) done();
                    return;
                }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshTopicQueue(); if (done) done(); })
                    .api_topicRequestEdit({ email: ctx.email, topic_id: topicId, comment });
            }
        });
    }

    function rejectTopic(topicId) {
        openActionModal({
            title: "Reject Topic " + topicId,
            label: "Please explain why this topic is being rejected.",
            requireComments: true,
            commentPlaceholder: "Rejection Reason (required)",
            onConfirm: (done) => {
                const comment = document.getElementById("amComments").value.trim();
                if (!comment) {
                    alert("Comment is required.");
                    if (done) done();
                    return;
                }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshTopicQueue(); if (done) done(); })
                    .api_topicReject({ email: ctx.email, topic_id: topicId, comment });
            }
        });
    }

    function loadHistory(type, id) {
        const historyArea = document.getElementById("amHistoryArea");
        if (historyArea) historyArea.innerHTML = "Loading records...";

        if (!ctx || !ctx.email) {
            if (historyArea) historyArea.innerText = "Error: Context not loaded. Wait or reload.";
            return;
        }

        google.script.run
            .withSuccessHandler(res => {
                if (!historyArea) return;
                if (!res || !res.ok) {
                    historyArea.innerText = "Error: " + (res ? res.message : "No response from server");
                    return;
                }

                const logs = res.logs || [];
                if (!logs.length) {
                    historyArea.innerHTML = "<div style='padding:12px; color:var(--text-muted);'>No history available.</div>";
                    return;
                }

                let html = "";
                logs.forEach(log => {
                    let dateStr = "";
                    try {
                        if (log.timestamp) {
                            const dt = new Date(log.timestamp);
                            dateStr = isNaN(dt.getTime()) ? String(log.timestamp) : dt.toLocaleString();
                        }
                    } catch (e) { dateStr = String(log.timestamp || ""); }

                    html += `<div class="history-item">
                    <span class="history-actor">${escapeHtml(log.actor_name || log.actor_email)}</span>
                    <span class="history-date">${dateStr}</span>
                    <div style="margin-top:4px; font-size:12px;">${log.action}: ${log.from_status || ''} ‚Üí ${log.to_status || ''}</div>
                    ${log.notes ? `<div style="margin-top:4px; font-size:12px; font-style:italic;">${escapeHtml(log.notes)}</div>` : ''}
                </div>`;
                });
                historyArea.innerHTML = html;
            })
            .withFailureHandler(err => {
                if (historyArea) {
                    historyArea.innerHTML = `<div style="color:red; padding:10px;">Error: ${escapeHtml(err.message || 'Unknown backend failure')}</div>`;
                }
            })
            .api_getHistory({ email: ctx.email, object_type: type, object_id: id });
    }

    function resubmitTopic(topicId, currentTitle) {
        openActionModal({
            title: "Resubmit Topic " + topicId,
            label: "Update Title & Add Notes",
            showInput: true,
            initialValue: currentTitle,
            placeholder: "Topic Title",
            commentPlaceholder: "Notes / Changes (optional)",
            onConfirm: (done) => {
                const newTitle = document.getElementById("amInput").value.trim();
                const newNotes = document.getElementById("amComments").value.trim();
                if (!newTitle) { alert("Title is required."); if (done) done(); return; }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); alert("Resubmitted!"); refreshMyTopics(); if (done) done(); })
                    .api_topicResubmit({ email: ctx.email, topic_id: topicId, topic_title: newTitle, notes: newNotes });
            }
        });
    }

    function discardTopic(topicId) {
        if (!confirm("Are you sure you want to discard this topic?")) return;
        google.script.run
            .withSuccessHandler(() => {
                refreshMyTopics();
            })
            .withFailureHandler(err => alert("Error: " + err.message))
            .api_topicDiscard({ email: ctx.email, topic_id: topicId });
    }

    // --- SUBMIT ARTICLE MODAL ---
    let currentTopicIdForArticle = null;

    function openSubmitArticle(topicId, title) {
        currentTopicIdForArticle = topicId;
        document.getElementById("sa_topicId").innerText = topicId;
        document.getElementById("sa_topicTitle").innerText = title;
        document.getElementById("sa_contentUrl").value = "";
        document.getElementById("sa_imageUrls").value = "";
        document.getElementById("sa_language").value = "Thai";
        document.getElementById("sa_notes").value = "";
        document.getElementById("sa_readyCheck").checked = false;
        document.getElementById("sa_msg").innerText = "";
        document.getElementById("submitArticleModal").classList.remove("hidden");
        window.scrollTo(0, 0);
    }

    function openResubmitArticle(articleId, topicTitle, contentUrl, notes) {
        // Re-use submit article modal for resubmission
        currentTopicIdForArticle = null; // We use articleId instead
        document.getElementById("sa_topicId").innerText = "Resubmitting Article " + articleId;
        document.getElementById("sa_topicTitle").innerText = topicTitle;
        document.getElementById("sa_contentUrl").value = contentUrl;
        document.getElementById("sa_notes").value = notes;
        document.getElementById("sa_readyCheck").checked = true;
        document.getElementById("sa_msg").innerText = "";

        // Override the submit button behavior temporarily or just handle in doSubmitArticle
        // For MVP simplicity, let's just use a window property
        window._resubmittingArticleId = articleId;

        document.getElementById("submitArticleModal").classList.remove("hidden");
        window.scrollTo(0, 0);
    }

    function closeSubmitArticle() {
        document.getElementById("submitArticleModal").classList.add("hidden");
        currentTopicIdForArticle = null;
        window._resubmittingArticleId = null;
    }

    function doSubmitArticle() {
        const btn = document.getElementById("btnSubmitArt");
        const url = document.getElementById("sa_contentUrl").value.trim();
        if (!url) {
            alert("Content URL is required.");
            return;
        }
        if (!document.getElementById("sa_readyCheck").checked) {
            alert("Please confirm the article is ready for review.");
            return;
        }

        btn.disabled = true;
        document.getElementById("sa_msg").innerText = "Submitting...";

        const payload = {
            email: ctx.email,
            content_doc_url: url,
            notes_to_reviewer: document.getElementById("sa_notes").value,
            image_urls: document.getElementById("sa_imageUrls").value,
            content_language: document.getElementById("sa_language").value
        };

        const isResubmit = !!window._resubmittingArticleId;
        if (isResubmit) {
            payload.article_id = window._resubmittingArticleId;
        } else {
            payload.topic_id = currentTopicIdForArticle;
        }

        google.script.run
            .withSuccessHandler(res => {
                btn.disabled = false;
                alert(isResubmit ? "Article resubmitted!" : "Article submitted! ID: " + res.article_id);
                closeSubmitArticle();
                refreshMyTopics();
            })
            .withFailureHandler(err => {
                btn.disabled = false;
                document.getElementById("sa_msg").innerText = "Error: " + err.message;
            })[isResubmit ? "api_articleResubmit" : "api_submitArticle"](payload);
    }

    // --- ARTICLE QUEUES ---



    // --- ACTIONS ---

    function claimArticle(id) {
        let warn = "";
        if (ctx.ooo && ctx.ooo.is_out_of_office) {
            warn = "\n\n‚ö†Ô∏è NOTE: You are currently marked as Out of Office (until " + (ctx.ooo.ooo_until || "further notice") + ").";
        }
        if (!confirm("Claim this article for review?" + warn)) return;
        google.script.run
            .withSuccessHandler(() => refreshArticleQueue())
            .withFailureHandler(err => alert("Error: " + err.message))
            .api_claimArticle({ email: ctx.email, article_id: id });
    }

    function reviewArticle(id, decision) {
        const requiredData = (decision === 'CHANGES' || decision === 'REJECT');
        let mTitle = decision === 'APPROVE' ? 'Approve' : (decision === 'CHANGES' ? 'Request edits for' : 'Reject');

        openActionModal({
            title: mTitle + " Article",
            label: "Article: " + id,
            requireComments: requiredData,
            commentPlaceholder: "Feedback to author" + (requiredData ? " (required)" : " (optional)"),
            onConfirm: (done) => {
                const commentData = document.getElementById("amComments").value.trim();
                if (requiredData && !commentData) {
                    alert("Comment is required.");
                    if (done) done();
                    return;
                }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshArticleQueue(); if (done) done(); })
                    .withFailureHandler(err => { alert(err.message); if (done) done(); })
                    .api_reviewArticle({ email: ctx.email, article_id: id, decision, comment: commentData });
            }
        });
    }

    function markPosted(id) {
        openActionModal({
            title: "Mark as Posted",
            label: "Article: " + id,
            showInput: true,
            placeholder: "Final Posted URL (https://...)",
            requireComments: false,
            commentPlaceholder: "Optional notes...",
            onConfirm: (done) => {
                const url = document.getElementById("amInput").value.trim();
                if (!url) {
                    alert("URL is required.");
                    if (done) done();
                    return;
                }
                const note = document.getElementById("amComments").value.trim();
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshPublisherQueue(); if (done) done(); })
                    .withFailureHandler(err => { alert(err.message); if (done) done(); })
                    .api_markPosted({ email: ctx.email, article_id: id, posted_url: url, notes: note });
            }
        });
    }

    function adminUnassign(id) {
        openActionModal({
            title: "Admin: Unassign Article",
            label: "Article: " + id,
            requireComments: true,
            commentPlaceholder: "Reason for unassigning (required)",
            onConfirm: (done) => {
                const rsn = document.getElementById("amComments").value.trim();
                if (!rsn) { alert("Reason is required."); if (done) done(); return; }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshArticleQueue(); if (done) done(); })
                    .withFailureHandler(err => { alert(err.message); if (done) done(); })
                    .api_adminUnassignArticle({ email: ctx.email, article_id: id, reason: rsn });
            }
        });
    }

    function adminOverrideArticle(id) {
        openActionModal({
            title: "Admin: Status Override",
            label: "Article: " + id,
            showInput: true,
            placeholder: "New status (e.g. Ready to Post)",
            requireComments: true,
            commentPlaceholder: "Reason for override (required)",
            onConfirm: (done) => {
                const stat = document.getElementById("amInput").value.trim();
                const rsn = document.getElementById("amComments").value.trim();
                if (!stat || !rsn) { alert("Status and Reason are required."); if (done) done(); return; }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshArticleQueue(); if (done) done(); })
                    .withFailureHandler(err => { alert(err.message); if (done) done(); })
                    .api_adminOverrideArticle({ email: ctx.email, article_id: id, status: stat, reason: rsn });
            }
        });
    }

    function adminOverrideTopic(id) {
        openActionModal({
            title: "Admin: Status Override",
            label: "Topic: " + id,
            showInput: true,
            placeholder: "New status (e.g. Approved)",
            requireComments: true,
            commentPlaceholder: "Reason for override (required)",
            onConfirm: (done) => {
                const stat = document.getElementById("amInput").value.trim();
                const rsn = document.getElementById("amComments").value.trim();
                if (!stat || !rsn) { alert("Status and Reason are required."); if (done) done(); return; }
                google.script.run
                    .withSuccessHandler(() => { closeActionModal(); refreshTopicQueue(); refreshMyTopics(); if (done) done(); })
                    .withFailureHandler(err => { alert(err.message); if (done) done(); })
                    .api_adminOverrideTopic({ email: ctx.email, topic_id: id, status: stat, reason: rsn });
            }
        });
    }

    function testSlack() {
        const page_id = document.getElementById("testSlackPage").value.trim();
        const type = document.getElementById("testSlackType").value;
        if (!page_id) {
            alert("Please enter a Page ID.");
            return;
        }
        document.getElementById("testSlackMsg").innerText = "Sending...";
        google.script.run
            .withSuccessHandler(res => {
                document.getElementById("testSlackMsg").style.color = "green";
                document.getElementById("testSlackMsg").innerText = res.message + " (" + (res.details || "") + ")";
            })
            .withFailureHandler(err => {
                document.getElementById("testSlackMsg").style.color = "red";
                document.getElementById("testSlackMsg").innerText = "Error: " + err.message;
            })
            .api_testSlack({ email: ctx.email, page_id, type });
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    try {
        console.log("Portal initializing...");
        bootstrap();
    } catch (e) {
        console.error("Initialization Error:", e);
        const el = document.getElementById('debugOut');
        if (el) el.innerText += '\nInit Crash: ' + e.message;
        document.getElementById("authStatus").innerText = "Fatal Error: " + e.message;
    }
</script>
</body>

</html>
